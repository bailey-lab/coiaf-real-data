---
title: "Comparison of estimation strategies"
author: "Aris Paschalidis"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

```{r setup, include = FALSE}
# Here, we set default options for our markdown file
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(coiaf)
library(ggplot2)
library(patchwork)
```

This analysis file will be used to compare the different estimation strategies
we employ to examine the COI in the world. The COI estimations we compare have
all been generated from the filtering process illustrated in the [download data
folder](https://github.com/bailey-lab/coiaf-real-data/tree/main/download).

## Loading estimations

```{r rmcl estimation}
rmcl_predictions <- readRDS(here::here(
  "data-outputs",
  "rmcl_estimation.rds"
))
```

```{r regional wsafs}
regional_wsafs <- readRDS(here::here(
  "data-outputs", 
  "regional_wsafs.rds"
)) %>% 
  dplyr::left_join(rmcl_predictions, by = c("name", "Region" = "region"))


regional_wsafs_2 <- readRDS(here::here(
  "data-outputs", 
  "regional_wsafs.rds"
)) %>% 
  dplyr::left_join(rmcl_predictions, by = c("name", "Region" = "region"))
```

```{r bind data }
bind_data <- dplyr::bind_rows(
  list(
    regional = regional_wsafs,
    regional_2 = regional_wsafs_2
  ), 
  .id = "dataset"
)
```

## Visualizing differences

```{r define some helpful functions, include = FALSE}
plot_bar <- function(data, col, xlab) {
 ggplot(data, aes({{ col }}, fill = dataset)) +
  geom_bar(position = "dodge") +
  scale_fill_viridis_d() +
  labs(x = xlab, y = "Count", fill = "Dataset") +
  theme_coiaf()
}

plot_density <- function(data, col, xlab) {
 ggplot(data, aes({{ col }}, fill = dataset)) +
  geom_density() +
  facet_wrap(~dataset) +
  scale_fill_viridis_d() +
  labs(x = xlab, y = "Density", fill = "Dataset") +
  theme_coiaf()
}

method_comparison <- function(data) {
  pdv <- plot_bar(data, dis_var, "Discrete Variant Method")
  pcv <- plot_density(data, cont_var, "Continuous Variant Method")

  pdf <- plot_bar(data, dis_freq, "Discrete Frequency Method")
  pcf <- plot_density(data, cont_freq, "Continuous Frequency Method")
  
  pdv + pcv + pdf + pcf + plot_layout(guides = "collect")
}

rmcl_helper <- function(data, col) {
  title <- switch(col,
    dis_var = "Discrete Variant Method",
    dis_freq = "Discrete Frequency Method",
    cont_var = "Continuous Variant Method",
    cont_freq = "Continuous Frequency Method"
  )
  
  ggplot(data, aes(x = rmcl_med, y = .data[[col]], color = dataset)) +
    facet_wrap(~dataset) +
    geom_abline(color = "gray", size = 0.5) +
    geom_jitter(alpha = 0.5) +
    theme_bw() +
    theme(
      panel.grid.minor = element_blank(), 
      plot.title = element_text(hjust = 0.5, size = 12), 
      legend.title = element_text(size = 12), 
      legend.position = "right"
    ) +
    guides(size = "none") +
    scale_x_continuous("THE REAL McCOIL Prediction", breaks = seq(0, 10)) +
    labs(title = title, y = "coiaf Prediction", color = "Dataset")
}

rmcl_comparison <- function(data) {
  data = dplyr::filter(data, rmcl_med != 25)
  
  rmcl_helper(data, "dis_var") + 
    rmcl_helper(data, "dis_freq") +
    rmcl_helper(data, "cont_var") +
    rmcl_helper(data, "cont_freq") + 
    plot_layout(guides = "collect")
}
```

```{r data sets methods}
method_comparison(bind_data)
```

```{r data sets rmcl}
rmcl_comparison(bind_data)
```

## Isolating samples where we deviate from RMCL

First find samples where RMCL predicts one but coiaf predicts a high COI.

```{r high coi samples}
high_samples <- bind_data %>%
  dplyr::filter(dataset == "regional", rmcl_med == 1, cont_freq >= 4) %>%
  dplyr::select(name, Region)
```

Plot the sample

```{r plot the sample}
path <- "~/Desktop/Malaria/COI data/wsafs-coverage/"
plots_per_figure <- 6

purrr::walk(1:6, function(i) {
  # Assign six plots per figure
  if (i %% plots_per_figure == 1) {
    pdf(paste0("analysis/comparison-figures/regional_samples_", i, ".pdf"))
    par(mfrow = c(3, 2))
  }

  # Determine sample name and region
  sample_name <- high_samples$name[i]
  sample_region <- high_samples$Region[i]

  # Isolate matrices
  region_matrix <- readRDS(paste0(
    path, 
    glue::glue("wsaf_reg_{sample_region}.rds")
  ))
  wsaf_matrix <- region_matrix$wsaf

  # Determine PLAF and WSAF
  plaf <- colMeans(wsaf_matrix, na.rm = T)
  wsaf <- wsaf_matrix[sample_name, ]
  input <- tibble::tibble(wsmaf = wsaf, plmaf = plaf) %>% tidyr::drop_na()

  # Find PLMAF and WSMAF
  minor <- input %>%
    dplyr::mutate(
      wsmaf = ifelse(plmaf > 0.5, 1 - wsmaf, wsmaf),
      plmaf = ifelse(plmaf > 0.5, 1 - plmaf, plmaf)
    ) %>%
    dplyr::filter(wsmaf > 0 & wsmaf < 1)

  # Plot
  plot(
    minor$plmaf, 
    minor$wsmaf, 
    main = sample_name, 
    pch = 20, 
    cex = 1, 
    col = "black"
  )

  # Stop writing to pdf file after 6 plots or after there are no more samples
  if (i %% plots_per_figure == 0 | i == nrow(high_samples)) dev.off()
})
```
